---
title: "R Notebook"
editor_options: 
  chunk_output_type: console
---


```{r libs}
# library(MASS)
# library(matrixcalc)
library(Matrix)
library(tidyr)
library(ggplot2)

library(vctrs)
library(fabletools)
library(fable)
library(feasts)
library(tsibble)
library(lubridate)
library(dplyr)

library(devtools)
load_all()

# library(purrr)
```

# Load data

```{r}
visnights_raw <- readr::read_csv(here::here("playground/data/visnights_monthly.csv")) |>
  mutate(Month = yearmonth(Month)) |>
  group_by(Month, Region) |>
  summarise(Nights = sum(Nights), .groups = "drop")
```

```{r states column}
# Define a mapping of regions to states -----------
state_map <- list(
  NSW = c(
    "Blue Mountains", "Central Coast", "Central NSW", "Goulburn",
    "Hunter", "New England North West", "North Coast NSW", "Outback NSW",
    "Riverina", "Snowy Mountains", "South Coast", "Sydney",
    "Capital Country"
  ),
  VIC = c(
    "Ballarat", "Bendigo Loddon", "Central Murray", "Geelong and the Bellarine",
    "Gippsland", "Great Ocean Road", "High Country", "Macedon", "Mallee",
    "Melbourne", "Melbourne East", "Murray East", "Peninsula", "Phillip Island",
    "Spa Country", "The Murray", "Upper Yarra", "Western Grampians", "Wimmera"
  ),
  QLD = c(
    "Brisbane", "Bundaberg", "Capricorn", "Fraser Coast", "Gladstone",
    "Gold Coast", "Mackay", "Outback Queensland", "Southern Queensland Country",
    "Sunshine Coast", "Townsville", "Tropical North Queensland",
    "Whitsundays"
  ),
  SA = c(
    "Adelaide", "Adelaide Hills", "Barossa", "Clare Valley", "Eyre Peninsula",
    "Fleurieu Peninsula", "Flinders Ranges and Outback", "Kangaroo Island",
    "Limestone Coast", "Murray River, Lakes and Coorong", "Riverland",
    "Yorke Peninsula"
  ),
  WA = c(
    "Australia's Coral Coast", "Australia's Golden Outback",
    "Australia's North West", "Australia's South West", "Destination Perth"
  ),
  TAS = c(
    "Central Highlands", "East Coast", "Hobart and the South",
    "Launceston and the North", "Lakes", "North West", "West Coast"
  ),
  NT = c(
    "Alice Springs", "Barkly", "Darwin", "Katherine Daly",
    "Litchfield Kakadu Arnhem", "Lasseter", "MacDonnell"
  ),
  ACT = c(
    "Canberra"
  )
)
# -----------

region_state_lookup <- tibble(
  State  = rep(names(state_map), lengths(state_map)),
  Region = unlist(state_map)
)

visnights <- visnights_raw %>%
  left_join(region_state_lookup, by = "Region") %>% 
  select(Month, State, Region, Nights)
```

```{r}
visnights %>% 
  group_by(Month, State) %>%
  summarise(Nights = sum(Nights), .groups = "drop") %>%
  ggplot(aes(x = Month, y = Nights, color = State)) +
    geom_line() +
    guides(color = "none") +
    theme_minimal()
```


# Modelling

```{r}
visnights_full <- visnights %>% 
  as_tsibble(index = Month, key = c(State, Region)) %>% 
  aggregate_key(State/Region, Nights = sum(Nights))
```


## Base fc

```{r}
year_filter <- 2015
fit <- visnights_full |>
  filter(year(Month) <= year_filter) |>
  model(base = ETS(Nights))

# base forecasts
h <- 12
fc <- fit %>% 
  forecast(h = h)
```


## S

```{r S mat}
key_data <- key_data(fit)
agg_data <- fabletools:::build_key_data_smat(key_data)

S <- matrix(0L, nrow = length(agg_data$agg), ncol = max(vec_c(!!!agg_data$agg)))
S[length(agg_data$agg)*(vec_c(!!!agg_data$agg)-1) + rep(seq_along(agg_data$agg), lengths(agg_data$agg))] <- 1L

# n_series <- length(agg_data$agg)
# n_bottom <- length(agg_data$leaf)
# S_dense <- matrix(0L, n_series, n_bottom)
# for(i in seq_len(n_series)) {
#   S_dense[i, agg_data$agg[[i]]] <- 1L
# }

# colnames
colnames(S) <- key_data %>% 
  filter(!is_aggregated(Region)) %>% 
  pull(Region) %>% 
  as.character()

# rownames
row_names <- key_data %>%
  distinct(State, Region) %>%
  mutate(
    name = case_when(
      Region == "<aggregated>" & State == "<aggregated>" ~ "Total",
      Region == "<aggregated>" ~ as.character(State),
      TRUE ~ as.character(Region)
    )
  )

rownames(S) <- row_names$name %>% 
  as.character()

```

## Get Data

```{r y and yhat}
# Get data from fit
fit_augment <- fit %>% 
  augment() %>% 
  filter(.model == "base") %>%
  left_join(row_names, by = c("State", "Region")) %>%
  select(Month, State, Region, name, .fitted, Nights)

y_hat <- fit_augment %>% 
  as_tibble() %>%
  select(.fitted, name, Month) %>%
  pivot_wider(names_from = name, values_from = .fitted) %>% 
  select(-Month) %>% 
  as.matrix()

y <- fit_augment %>% 
  as_tibble() %>%
  select(Nights, name, Month) %>%
  pivot_wider(names_from = name, values_from = Nights) %>% 
  select(-Month) %>% 
  as.matrix()
```

```{r base_fc}
base_fc <- fc %>% 
  as_tibble() %>% 
  left_join(row_names, by = c("State", "Region")) %>%
  select(name, .mean, Month) %>%
  pivot_wider(names_from = name, values_from = .mean) %>%
  select(-Month) %>% 
  as.matrix()
```

```{r}
actual <- visnights_full %>% 
  filter(year(Month) > year_filter & year(Month) <= year_filter +1) %>% 
  as_tibble() %>% 
  arrange(State, Region) %>%
  left_join(row_names, by = c("State", "Region")) %>%
  select(name, Nights, Month) %>%
  pivot_wider(names_from = name, values_from = Nights) %>%
  select(-Month) %>%
  as.matrix()
```

## Reconcile

```{r cov ests}
W_shr <- shrinkage_est(
  y - y_hat
)

window <- round(dim(y)[1] * 0.5)
W_n <- novelist_cv(
  y,
  y_hat,
  S,
  window = window,
  deltas = seq(0, 1, by = 0.05),
  ensure_PD = TRUE,
  message = TRUE
)
```

```{r recon}
recon_mint_shr <- reconcile_mint(base_fc, S, W_shr$cov)
recon_mint_n <- reconcile_mint(base_fc, S, W_n$cov)

sample_cov <- compute_cov_matrix(y - y_hat, zero_mean = T)
if (any(eigen(sample_cov)$values < 1e-8)) {
  cat("Sample covariance for mint_sample is singular, using nearPD\n")
  sample_cov <- nearPD(sample_cov)$mat
}
recon_mint_sample <- reconcile_mint(base_fc, S, sample_cov)
```

# Evaluation

```{r}
# fc %>% 
#   accuracy(visnights_full, measures = list(RMSE = RMSE))
# 
# sqrt(colMeans((actual - base_fc)^2))

error_sq <- list(
  base = ((actual - base_fc)^2),
  mint_shr = ((actual - recon_mint_shr)^2),
  mint_n = ((actual - recon_mint_n)^2),
  mint_sample = ((actual - recon_mint_sample)^2)
)
error_sq <- transform_sim_MSE(error_sq, F)


```

```{r}
error_sq |>
  group_by(series, h) |>
  mutate(
    base_MSE = MSE[.model == "base"]
  ) |>
  ungroup() |>
  group_by(.model, h) |>
  summarise(
    MSE = mean(MSE),
    base_MSE = mean(base_MSE),
    pct_change = (MSE - base_MSE) / base_MSE * 100
  ) |>
  filter(h <=16) |>
  ggplot(aes(x = h, y = pct_change, color = .model)) +
    geom_line() +
    labs(x = "Horizon", y = "% relative improvements in MSE") +
    theme_minimal()
```

# CV Parallel

## run

```{r}
run <- function(data, start, end, S) {
  
  fit <- data |>
    filter(Month >= start & Month <= end) |>
    model(base = ETS(Nights))
  
  # base forecasts
  h <- 12
  fc <- fit %>% 
    forecast(h = h)
  
  # Get data from fit
  fit_augment <- fit %>% 
    augment() %>% 
    filter(.model == "base") %>%
    left_join(row_names, by = c("State", "Region")) %>%
    select(Month, State, Region, name, .fitted, Nights)
  
  y_hat <- fit_augment %>% 
    as_tibble() %>%
    select(.fitted, name, Month) %>%
    pivot_wider(names_from = name, values_from = .fitted) %>% 
    select(-Month) %>% 
    as.matrix()
  
  y <- fit_augment %>% 
    as_tibble() %>%
    select(Nights, name, Month) %>%
    pivot_wider(names_from = name, values_from = Nights) %>% 
    select(-Month) %>% 
    as.matrix()
  
  # Get base forecasts
  base_fc <- fc %>% 
    as_tibble() %>% 
    left_join(row_names, by = c("State", "Region")) %>%
    select(name, .mean, Month) %>%
    pivot_wider(names_from = name, values_from = .mean) %>%
    select(-Month) %>% 
    as.matrix()
  
  # Get actual values
  actual <- data %>% 
    filter(Month > end & Month <= end + 11) %>% 
    as_tibble() %>% 
    arrange(State, Region) %>%
    left_join(row_names, by = c("State", "Region")) %>%
    select(name, Nights, Month) %>%
    pivot_wider(names_from = name, values_from = Nights) %>%
    select(-Month) %>%
    as.matrix()
  
  # Cov estimators
  W_shr <- shrinkage_est(
    y - y_hat
  )
  
  window <- round(dim(y)[1] * 0.66)
  W_n <- novelist_cv(
    y,
    y_hat,
    S,
    window = window,
    deltas = seq(0, 1, by = 0.05),
    ensure_PD = TRUE,
    message = TRUE
  )
  
  # Reconcile
  recon_mint_shr <- reconcile_mint(base_fc, S, W_shr$cov)
  recon_mint_n <- reconcile_mint(base_fc, S, W_n$cov)
  
  sample_cov <- compute_cov_matrix(y - y_hat, zero_mean = T)
  if (any(eigen(sample_cov)$values < 1e-8)) {
    cat("Sample covariance for mint_sample is singular, using nearPD\n")
    sample_cov <- nearPD(sample_cov)$mat
  }
  recon_mint_sample <- reconcile_mint(base_fc, S, sample_cov)
  
  e2 <- list(
    base = ((actual - base_fc)^2),
    mint_shr = ((actual - recon_mint_shr)^2),
    mint_n = ((actual - recon_mint_n)^2),
    mint_sample = ((actual - recon_mint_sample)^2)
  )
  
  return(list(
    e2 = e2,
    W_shr = W_shr$lambda,
    W_n = c(W_n$lambda, W_n$delta)
  ))
}
```

## Parallel

```{r}
library(future.apply)
library(progressr)

handlers(global = TRUE) # Setup progress bar handler
handlers("txtprogressbar")  # or "progress" for a fancier bar

plan(multisession, workers = parallel::detectCores() - 2)


model_names <- c("base", "mint_shr", "mint_n", "mint_sample")
SSE_cum <- setNames(
  lapply(model_names, function(name) {
    matrix(0, h, length(rownames(S)), dimnames = list(1:h, rownames(S)))
  }),
  model_names
)

# moving 1 month forward
start_date <- visnights_full$Month[1]
end_date <- yearmonth("2015-01")
M <- 4
seq_dates <- list(
  start = start_date + 0:(M-1),
  end = end_date + 0:(M-1)
)

# parallel with progress bar
with_progress({
  p <- progressor(along = 1:M)  # auto sets steps = length
  
  result_list <- future_lapply(
    1:M, 
    function(i) {
      p(message = sprintf("Sim %d", i))  # advances safely
      
      start <- seq_dates$start[i]
      end <- seq_dates$end[i]
      run(
        visnights_full,
        start,
        end,
        S
      )
    },
    future.seed=TRUE
  )
})

result_list <- future_lapply(
  1:4, 
  function(i) {
    start <- seq_dates$start[i]
    end <- seq_dates$end[i]
    run(
      visnights_full,
      start,
      end,
      S
    )
  },
  future.seed=TRUE
)
```

