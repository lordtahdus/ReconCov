---
title: "R Notebook"
editor_options: 
  chunk_output_type: console
---


```{r libs}
# library(MASS)
# library(matrixcalc)
# library(Matrix)
library(tidyr)
library(ggplot2)

library(vctrs)
library(fabletools)
library(fable)
library(feasts)
library(tsibble)
library(dplyr)

library(devtools)
load_all()

# library(purrr)
```

# Load data

```{r}
visnights_raw <- readr::read_csv(here::here("playground/data/visnights_monthly.csv")) |>
  mutate(Month = yearmonth(Month)) |>
  group_by(Month, Region) |>
  summarise(Nights = sum(Nights), .groups = "drop")
```

```{r states column}
# Define a mapping of regions to states -----------
state_map <- list(
  NSW = c(
    "Blue Mountains", "Central Coast", "Central NSW", "Goulburn",
    "Hunter", "New England North West", "North Coast NSW", "Outback NSW",
    "Riverina", "Snowy Mountains", "South Coast", "Sydney",
    "Capital Country"
  ),
  VIC = c(
    "Ballarat", "Bendigo Loddon", "Central Murray", "Geelong and the Bellarine",
    "Gippsland", "Great Ocean Road", "High Country", "Macedon", "Mallee",
    "Melbourne", "Melbourne East", "Murray East", "Peninsula", "Phillip Island",
    "Spa Country", "The Murray", "Upper Yarra", "Western Grampians", "Wimmera"
  ),
  QLD = c(
    "Brisbane", "Bundaberg", "Capricorn", "Fraser Coast", "Gladstone",
    "Gold Coast", "Mackay", "Outback Queensland", "Southern Queensland Country",
    "Sunshine Coast", "Townsville", "Tropical North Queensland",
    "Whitsundays"
  ),
  SA = c(
    "Adelaide", "Adelaide Hills", "Barossa", "Clare Valley", "Eyre Peninsula",
    "Fleurieu Peninsula", "Flinders Ranges and Outback", "Kangaroo Island",
    "Limestone Coast", "Murray River, Lakes and Coorong", "Riverland",
    "Yorke Peninsula"
  ),
  WA = c(
    "Australia's Coral Coast", "Australia's Golden Outback",
    "Australia's North West", "Australia's South West", "Destination Perth"
  ),
  TAS = c(
    "Central Highlands", "East Coast", "Hobart and the South",
    "Launceston and the North", "Lakes", "North West", "West Coast"
  ),
  NT = c(
    "Alice Springs", "Barkly", "Darwin", "Katherine Daly",
    "Litchfield Kakadu Arnhem", "Lasseter", "MacDonnell"
  ),
  ACT = c(
    "Canberra"
  )
)
# -----------

region_state_lookup <- tibble(
  State  = rep(names(state_map), lengths(state_map)),
  Region = unlist(state_map)
)

visnights <- visnights_raw %>%
  left_join(region_state_lookup, by = "Region") %>% 
  select(Month, State, Region, Nights)
```

# Modelling

```{r}
visnights_full <- visnights %>% 
  as_tsibble(index = Month, key = c(State, Region)) %>% 
  aggregate_key(State/Region, Nights = sum(Nights))
```

## Base fc

```{r}
fit <- visnights_full |>
  filter(year(Month) <= 2015) |>
  model(base = ETS(Nights))

# base forecasts
h <- 12
fc <- fit %>% 
  forecast(h = h)
```


## S

```{r S mat}
key_data <- key_data(fit)
agg_data <- fabletools:::build_key_data_smat(key_data)

S <- matrix(0L, nrow = length(agg_data$agg), ncol = max(vec_c(!!!agg_data$agg)))
S[length(agg_data$agg)*(vec_c(!!!agg_data$agg)-1) + rep(seq_along(agg_data$agg), lengths(agg_data$agg))] <- 1L

# n_series <- length(agg_data$agg)
# n_bottom <- length(agg_data$leaf)
# S_dense <- matrix(0L, n_series, n_bottom)
# for(i in seq_len(n_series)) {
#   S_dense[i, agg_data$agg[[i]]] <- 1L
# }

# colnames
colnames(S) <- key_data %>% 
  filter(!is_aggregated(Region)) %>% 
  pull(Region) %>% 
  as.character()

# rownames
row_names <- key_data %>%
  distinct(State, Region) %>%
  mutate(
    name = case_when(
      Region == "<aggregated>" & State == "<aggregated>" ~ "Total",
      Region == "<aggregated>" ~ as.character(State),
      TRUE ~ as.character(Region)
    )
  )

rownames(S) <- row_names$name %>% 
  as.character()

```

## Get Data

```{r y and yhat}
# Get data from fit
fit_augment <- fit %>% 
  augment() %>% 
  filter(.model == "base") %>%
  left_join(row_names, by = c("State", "Region")) %>%
  select(Month, State, Region, name, .fitted, Nights)

y_hat <- fit_augment %>% 
  as_tibble() %>%
  select(.fitted, name, Month) %>%
  pivot_wider(names_from = name, values_from = .fitted) %>% 
  select(-Month) %>% 
  as.matrix()

y <- fit_augment %>% 
  as_tibble() %>%
  select(Nights, name, Month) %>%
  pivot_wider(names_from = name, values_from = Nights) %>% 
  select(-Month) %>% 
  as.matrix()
```

```{r base_fc}
base_fc <- fc %>% 
  as_tibble() %>% 
  left_join(row_names, by = c("State", "Region")) %>%
  select(name, .mean, Month) %>%
  pivot_wider(names_from = name, values_from = .mean) %>%
  select(-Month) %>% 
  as.matrix()
```


## Reconcile

```{r}

```

