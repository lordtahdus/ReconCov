---
title: "R Notebook"
editor_options: 
  chunk_output_type: console
---


```{r}
library(MASS)
library(matrixcalc)
library(Matrix)
library(dplyr)
library(tidyr)

library(fabletools)
library(fable)
library(feasts)

library(devtools)
load_all()
```


```{r}
groups <- c(2,3)
# diag_range <- c(0.2, 0.9)

A <- generate_block_diag(
  groups = groups
)

Sigma <- generate_cor(
  groups = groups
)

bottom <- simulate_bottom_var(groups, T = 100, intercept = 100)

# build_hierarchy(bottom$Y, bottom$groups)$hier_data
```

```{r}
build_2level_hierarchy <- function(bottom_data, groups) {
  
  T <- nrow(bottom_data)
  p <- ncol(bottom_data)
  
  # Number of groups
  G <- length(groups)
  
  # Level 1 (Group-level) aggregation:
  group_indices <- split(1:p, rep(1:G, groups))
  S_group <- matrix(0, nrow = G, ncol = p)
  for (i in seq_len(G)) {
    S_group[i, group_indices[[i]]] <- 1
  }
  
  # Level 2 (Top-level) aggregation:
  S_top <- matrix(1, nrow = 1, ncol = p)
  # Bottom-level is the identity matrix.
  S_bottom <- diag(1, nrow = p, ncol = p)
  
  # Combine the summation rows.
  # Order: Top-level, then Group-level, then Bottom-level.
  S <- rbind(S_top, S_group, S_bottom)
  
  # Aggregate the data.
  hier_data <- bottom_data %*% t(S)
  
  # Create series names.
  series_names <- c("Top", paste0("G", seq_len(G)), paste0("B", 1:p))
  colnames(hier_data) <- series_names
  rownames(S) <- series_names
  
  return(list(
    hier_data = hier_data,  # T x M, where M = 1 + G + p
    S = S,                  # (1 + G + p) x p summation matrix.
    series_names = series_names
  ))
}
```

```{r}
info_2level <- build_2level_hierarchy(bottom$Y, bottom$groups)
S <- info_2level$S
hts <- info_2level$hier_data

```


# NOVELIST

```{r}
bottom_series <- hts[,4:8] %>% 
  as.data.frame() %>% 
  mutate(time = seq(1, nrow(hts))) %>% 
  # select(time, everything()) %>% 
  as_tsibble(index = time) %>% 
  pivot_longer(
    cols = -time,
    names_to = "series",
    values_to = "value"
  )

fit <- bottom_series %>% 
  filter(time <= 80) %>% 
  model(
    arima = ARIMA(value)
  )

```


*Get in-sample actual & fitted values*

```{r}
y_hat <- fit %>% 
  augment() %>% 
  select(.fitted, series) %>%
  pivot_wider(names_from = series, values_from = .fitted) %>% 
  as_tibble() %>% 
  select(-time) %>% 
  as.matrix()

y <- hts[1:80,4:8]
```

