---
title: "R Notebook"
editor_options: 
  chunk_output_type: console
---


```{r libs}
library(MASS)
# library(matrixcalc)
library(Matrix)
library(tidyr)
library(ggplot2)

library(fabletools)
library(fable)
library(feasts)
library(tsibble)
library(dplyr)

library(devtools)
load_all()

library(purrr)
```


# Read

```{r}
file <- "S4-2-1_100"
path <- paste("sim_results/", file, ".rds", sep = "")
results <- readRDS(path)

MSE <- results$MSE
W_shr <- results$W_shr
W_n <- results$W_n
```

# Inspect

```{r}
list_MSE_to_ts <- function(MSE) {
  imap_dfr(MSE, function(mat, model_name) {
    as_tibble(mat) %>%
      mutate(h = row_number()) %>%
      pivot_longer(cols = -h, names_to = "series", values_to = "MSE") %>%
      mutate(
        .model = model_name,
      ) %>%
      select(.model, series, h, MSE)
  }) %>%
  as_tsibble(key = c(.model, series), index = h)
}

MSE_ts <- list_MSE_to_ts(results$MSE)

MSE_ts |> group_by(.model) |> index_by(h) |>
  summarise(mse = mean(MSE)) |>
  ggplot(aes(x = h, y = mse, color = .model)) +
    geom_line() +
    labs(x = "Horizon", y = "MSE") +
    theme_minimal()

```

```{r}
# params from shrinkage and novelist

results$W_shr[results$W_shr == results$W_n[,1]] %>% length()

plot(
  results$W_shr,
  results$W_n[,1]
)

# filter diff
cond <- results$W_shr != results$W_n[,1]
cond <- results$W_shr != results$W_n[,1] & results$W_n[,1] < 0.3

# lambdas given thresholded != identity
plot(
  results$W_shr[cond],
  results$W_n[,1][cond]
)
abline(a = 0, b = 1, col = "red", lty = 1)

plot(results$W_n)
# lambda vs delta NOVELIST given thresholded != identity
plot(
  results$W_n[,1][cond],
  results$W_n[,2][cond]
)
```

# Compare between 2 simulations

```{r}
MSE1 <- list_MSE_to_ts(sim1$MSE)
MSE2 <- list_MSE_to_ts(sim2$MSE)

MSE1 |> group_by(.model) |> index_by(h) |>
  summarise(mse = mean(MSE)) |>
  ggplot(aes(x = h, y = mse, color = .model)) +
    geom_line() +
    labs(x = "Horizon", y = "MSE") +
    theme_minimal()

MSE2 |> group_by(.model) |> index_by(h) |>
  summarise(mse = mean(MSE)) |>
  ggplot(aes(x = h, y = mse, color = .model)) +
    geom_line() +
    labs(x = "Horizon", y = "MSE") +
    theme_minimal()

```


```{r}
temp <- temp1
for (i in 1:4){
  temp$MSE[[i]] <- (temp$MSE[[i]] * 200 + temp2$MSE[[i]]*300) / 500
}

temp$W_shr <- c(temp$W_shr, temp2$W_shr)
temp$W_n <- rbind(temp$W_n, temp2$W_n)
saveRDS(
  temp, 
  file = "sim/sim_results/S16-4-2-1_T100_M500.rds"
)
```



